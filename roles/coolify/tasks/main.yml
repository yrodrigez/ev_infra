---
- name: Check if Coolify is already installed
  stat:
    path: "{{ coolify_data_dir }}/source/.env"
  register: coolify_installed

- name: Ensure data directory exists
  file:
    path: "{{ coolify_data_dir }}"
    state: directory
    mode: '0755'
  when: not coolify_installed.stat.exists

- name: Download Coolify installer
  get_url:
    url: https://cdn.coollabs.io/coolify/install.sh
    dest: /tmp/coolify-install.sh
    mode: '0755'
  when: not coolify_installed.stat.exists

- name: Run Coolify installer (this may take 5-10 minutes)
  command:
    cmd: /tmp/coolify-install.sh -f
  environment:
    TERM: xterm
  when: not coolify_installed.stat.exists
  register: coolify_install_result
  changed_when: true

- name: Wait for Coolify to be ready
  uri:
    url: "http://localhost:8000"
    status_code: [200, 302]
  register: coolify_health
  retries: 30
  delay: 10
  until: coolify_health.status in [200, 302]
  when: not coolify_installed.stat.exists

- name: Get Raspberry Pi IP address
  set_fact:
    pi_ip: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}"

- name: Display Coolify access info
  debug:
    msg:
      - "============================================="
      - "Coolify installed successfully!"
      - "Access the UI at: http://{{ pi_ip }}:8000"
      - "Complete the setup wizard to configure:"
      - "  1. Admin account"
      - "  2. Cloudflare Tunnel (Settings > Integrations)"
      - "============================================="
