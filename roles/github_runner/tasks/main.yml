---
- name: Create runner user
  user:
    name: "{{ runner_user }}"
    shell: /bin/bash
    groups: docker
    append: yes

- name: Create runner directory
  file:
    path: "{{ runner_dir }}"
    state: directory
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0755'

- name: Install dependencies
  apt:
    name:
      - curl
      - jq
      - libdigest-sha-perl
      # Dotnet dependencies (required for runner)
      - libicu-dev
      - libssl-dev
    state: present
    update_cache: yes

- name: Check if runner is already configured
  stat:
    path: "{{ runner_dir }}/.runner"
  register: runner_configured

- name: Download GitHub Runner
  get_url:
    url: "https://github.com/actions/runner/releases/download/v{{ runner_version }}/actions-runner-linux-arm64-{{ runner_version }}.tar.gz"
    dest: "{{ runner_dir }}/actions-runner.tar.gz"
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
    mode: '0644'
  when: not runner_configured.stat.exists

- name: Extract GitHub Runner
  unarchive:
    src: "{{ runner_dir }}/actions-runner.tar.gz"
    dest: "{{ runner_dir }}"
    remote_src: yes
    owner: "{{ runner_user }}"
    group: "{{ runner_user }}"
  when: not runner_configured.stat.exists

- name: Fail if GitHub PAT is missing
  fail:
    msg: "GitHub PAT is missing. Please ensure secrets.fact has github_pat."
  when: not runner_configured.stat.exists and (github_pat is not defined or github_pat == '')

- name: Get Registration Token from GitHub
  uri:
    url: "https://api.github.com/repos/{{ repo_url | regex_replace('^https://github.com/', '') }}/actions/runners/registration-token"
    method: POST
    headers:
      Authorization: "token {{ github_pat }}"
      Accept: "application/vnd.github.v3+json"
    status_code: 201
    return_content: yes
  register: registration_token_response
  when: not runner_configured.stat.exists

- name: Configure Runner
  command:
    cmd: "./config.sh --url {{ repo_url }} --token {{ registration_token_response.json.token }} --unattended --name {{ ansible_hostname }} --labels raspberry-pi,arm64"
    chdir: "{{ runner_dir }}"
  become: yes
  become_user: "{{ runner_user }}"
  when: not runner_configured.stat.exists
  register: config_result
  ignore_errors: yes

- name: Debug Runner Config Failure
  debug:
    msg: 
      - "Runner configuration failed!"
      - "URL: {{ repo_url }}"
      - "Note: Token used was dynamically generated via PAT"
      - "Command output: {{ config_result.stderr }}"
  when: config_result.failed

- name: Debug Runner Config Failure
  debug:
    msg: 
      - "Runner configuration failed!"
      - "URL: {{ repo_url }}"
      - "Token length: {{ runner_token | length }}"
      - "Command output: {{ config_result.stderr }}"
  when: config_result.failed

- name: Install Runner Service
  command:
    cmd: "./svc.sh install {{ runner_user }}"
    chdir: "{{ runner_dir }}"
  ignore_errors: yes # Ignore if already installed

- name: Start Runner Service
  command:
    cmd: "./svc.sh start"
    chdir: "{{ runner_dir }}"
  ignore_errors: yes # Ignore if already started
